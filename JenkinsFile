stage 'VCS checkout'

node('master'){
	cleanDirectoryLinux('jenkins-build')
  git branch: 'v2.0.0', url: 'https://github.com/VirgilSecurity/virgil-cli.git'
	stash includes: '**', name: 'src'
}


stage 'Build'

def slaves = [:]
slaves['build-centos7'] = createCentos('build-centos7')

parallel slaves

def createCentos(slaveName){
	println "Building for centos7"
	return{
		node(slaveName){
			deleteDir()
			unstash 'src'
			cleanDirectoryLinux("build")
			dir("build"){
				sh "cmake .."
				sh "make"
				cleanDirectoryLinux("install")
				sh "make install DESTDIR=./install"
				dir("install"){
						sh "tar czvf ../virgil-cli.tgz ."
				}
				archiveArtifacts("virgil-cli.tgz")
			}
		}
	}
}

def createWindows(slaveName){
	println "Plug for windows build. It not defined yet"
}

def cleanDirectoryLinux(dirPath) {
	println "Clean directory: ${dirPath}"

	def dirCheck = fileExists dirPath

	switch(dirCheck){
		case true:
			println "Delete directory: ${dirPath}"
			dir(dirPath){
			    deleteDir()
			}
			cleanDirectoryLinux(dirPath)
			break

		case false:
			println "Create directory: ${dirPath}"
			if(isUnix()){
			    sh "mkdir -p ${dirPath}"
			} else {
			    bat "mkdir ${dirPath}"
			}
			break

		default:
			println "[ERROR]: Something goes wrong in cleanDirectoryLinuxLinux function"
	}
}

def archiveArtifacts(pattern) {
    step([$class: 'ArtifactArchiver', artifacts: pattern, fingerprint: true, onlyIfSuccessful: true])
}
